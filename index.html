<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>การลบเศษส่วน ป.6</title>
    <link rel="icon" type="image/png" href="https://img2.pic.in.th/pic/-1d866e1b6906965dd.png">
    <style>
        /* General Styling */
        :root {
            --primary-color: #007bff;
            --secondary-color: #f4f7f9;
            --dark-text: #333;
            --light-text: #fff;
            --border-color: #ccc;
            --success-color: #52c41a;
            --danger-color: #ff4d4f;
        }

        body {
            font-family: 'Sarabun', sans-serif;
            font-size: 1.2rem;
            color: #333;
            background-image: url('https://lh5.googleusercontent.com/d/1oouLUYoOV-tdt5eGKs4VV_tef7rY8ues');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        
        /* Main Layout */
        .game-container {
            width: 100%;
            max-width: 1200px;
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: var(--light-text);
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .lives-container { font-size: 2rem; }
        .timer-container {
            width: 70%;
            height: 25px;
            background-color: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
        }
        #timer-bar {
            height: 100%;
            width: 100%;
            background-color: var(--success-color);
            border-radius: 15px;
            transition: width 1s linear, background-color 0.5s;
        }

        .container {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            width: 100%;
        }

        .worksheet {
            flex: 2;
            min-width: 400px;
            background: var(--light-text);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            position: relative;
        }

        .options-bank {
            flex: 1;
            min-width: 300px;
            background: #eef3f7;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
            align-self: flex-start;
        }
        
        #options-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }

        /* Pagination */
        .page { display: none; }
        .page.active { display: block; }
        
        /* Problem Styling */
        .problem-line {
            display: flex;
            align-items: center;
            margin-left: 10px;
            min-height: 55px;
            gap: 10px;
        }
        .equals { font-weight: bold; }
        
        .drop-zone {
            flex-grow: 1;
            height: 45px;
            border: 2px dashed var(--border-color);
            border-radius: 5px;
            transition: background-color 0.3s, border-color 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 5px;
        }
        .drop-zone.over { background-color: #e6f7ff; border-color: #91d5ff; }
        .drop-zone.correct { border-color: var(--success-color); background-color: #f6ffed; border-style: solid; }
        .drop-zone.incorrect {
            animation: shake 0.5s;
            border-color: var(--danger-color);
            background-color: #fff1f0;
        }

        .draggable {
            background-color: var(--light-text);
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: grab;
            user-select: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: background-color 0.3s, transform 0.2s;
            text-align: center;
            flex-shrink: 0;
        }
        .draggable.dragging { opacity: 0.5; }
        
        .frac { display: inline-block; vertical-align: middle; text-align: center; font-size: 1rem; }
        .frac > span { display: block; padding: 0.1em; }
        .frac span.bottom { border-top: 1px solid; }
        
        /* Controls */
        .controls { margin-top: 20px; text-align: center; }
        button {
            background-color: var(--primary-color);
            color: var(--light-text);
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s;
            margin: 0 5px;
        }
        button:hover { background-color: #0056b3; }
        .student-assign-btn { font-size: 0.8rem; padding: 4px 8px; background-color: #6c757d; }
        .student-name { font-weight: bold; color: var(--primary-color); min-width: 80px; text-align: left; }
        
        /* Spinner Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0; top: 0;
            width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: var(--light-text);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        #name-editor {
            display: none;
            margin-top: 15px;
        }
        #name-textarea {
            width: 90%;
            height: 100px;
            margin-bottom: 10px;
        }

        /* Animation */
        @keyframes shake {
          10%, 90% { transform: translate3d(-1px, 0, 0); }
          20%, 80% { transform: translate3d(2px, 0, 0); }
          30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
          40%, 60% { transform: translate3d(4px, 0, 0); }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1>การลบเศษส่วน</h1>
        <div class="game-header">
            <div id="lives-container" class="lives-container"></div>
            <div class="timer-container">
                <div id="timer-bar"></div>
            </div>
        </div>

        <div class="container">
            <div class="worksheet">
                <div id="page-container">
                    </div>
                 <div class="controls">
                    <button id="reset-button">เริ่มต้นใหม่</button>
                    <button id="next-button">ข้อถัดไป</button>
                </div>
            </div>

            <div class="options-bank">
                <h2>กล่องตัวเลือก</h2>
                <div id="options-container"></div>
            </div>
        </div>
    </div>

    <div id="spinner-modal" class="modal">
        <div class="modal-content">
            <h2>วงล้อสุ่มชื่อ</h2>
            <canvas id="wheel-canvas" width="400" height="400"></canvas>
            <br>
            <button id="spin-button">หมุน!</button>
            <button id="edit-names-button">แก้ไขรายชื่อ</button>
            <div id="name-editor">
                <p>ใส่รายชื่อ คั่นด้วยเครื่องหมายจุลภาค (,) หรือขึ้นบรรทัดใหม่</p>
                <textarea id="name-textarea"></textarea><br>
                <button id="save-names-button">บันทึก</button>
            </div>
        </div>
    </div>


    <script>
    const problemsData = [
        { // Problem 1
            question: `1. &nbsp; <span class="frac"><span>8</span><span class="bottom">9</span></span> &nbsp; - &nbsp; <span class="frac"><span>3</span><span class="bottom">7</span></span> &nbsp; = &nbsp; ⬜`,
            lines: 4,
            answers: [
                { id: 'ans1-1', html: `<span class="frac"><span>8 × 7</span><span class="bottom">9 × 7</span></span> - <span class="frac"><span>3 × 9</span><span class="bottom">7 × 9</span></span>` },
                { id: 'ans1-2', html: `<span class="frac"><span>56</span><span class="bottom">63</span></span> - <span class="frac"><span>27</span><span class="bottom">63</span></span>` },
                { id: 'ans1-3', html: `<span class="frac"><span>29</span><span class="bottom">63</span></span>` },
                { id: 'ans1-4', html: `<b><span class="frac"><span>๒๙</span><span class="bottom">๖๓</span></span></b>` }
            ]
        },
        { // Problem 2
            question: `2. &nbsp; 2<span class="frac"><span>6</span><span class="bottom">13</span></span> &nbsp; - &nbsp; 1<span class="frac"><span>1</span><span class="bottom">4</span></span> &nbsp; = &nbsp; ⬜`,
            lines: 4,
            answers: [
                { id: 'ans2-1', html: `(2 + <span class="frac"><span>6 × 4</span><span class="bottom">13 × 4</span></span>) - (1 + <span class="frac"><span>1 × 13</span><span class="bottom">4 × 13</span></span>)` },
                { id: 'ans2-2', html: `2 + (<span class="frac"><span>24</span><span class="bottom">52</span></span> - <span class="frac"><span>13</span><span class="bottom">52</span></span>)` },
                { id: 'ans2-3', html: `2 + <span class="frac"><span>11</span><span class="bottom">52</span></span>` },
                { id: 'ans2-4', html: `<b>๒<span class="frac"><span>๑๑</span><span class="bottom">๕๒</span></span></b>` }
            ]
        },
        { // Problem 3
            question: `3. &nbsp; 2<span class="frac"><span>3</span><span class="bottom">5</span></span> &nbsp; - &nbsp; <span class="frac"><span>7</span><span class="bottom">12</span></span> &nbsp; = &nbsp; ⬜`,
            lines: 5,
            answers: [
                { id: 'ans3-1', html: `2 + (<span class="frac"><span>3 × 12</span><span class="bottom">5 × 12</span></span> - <span class="frac"><span>7 × 5</span><span class="bottom">12 × 5</span></span>)` },
                { id: 'ans3-2', html: `2 + (<span class="frac"><span>36</span><span class="bottom">60</span></span> - <span class="frac"><span>35</span><span class="bottom">60</span></span>)` },
                { id: 'ans3-3', html: `2 + <span class="frac"><span>1</span><span class="bottom">60</span></span>` },
                { id: 'ans3-4', html: `2<span class="frac"><span>1</span><span class="bottom">60</span></span>` },
                { id: 'ans3-5', html: `<b>๒<span class="frac"><span>๑</span><span class="bottom">๖๐</span></span></b>` }
            ]
        },
        { // Problem 4
            question: `4. &nbsp; 5<span class="frac"><span>16</span><span class="bottom">19</span></span> &nbsp; - &nbsp; 3<span class="frac"><span>5</span><span class="bottom">6</span></span> &nbsp; = &nbsp; ⬜`,
            lines: 5,
            answers: [
                { id: 'ans4-1', html: `(5 + <span class="frac"><span>16 × 6</span><span class="bottom">19 × 6</span></span>) - (3 + <span class="frac"><span>5 × 19</span><span class="bottom">6 × 19</span></span>)` },
                { id: 'ans4-2', html: `(5 - 3) + (<span class="frac"><span>96</span><span class="bottom">114</span></span> - <span class="frac"><span>95</span><span class="bottom">114</span></span>)` },
                { id: 'ans4-3', html: `2 + <span class="frac"><span>1</span><span class="bottom">114</span></span>` },
                { id: 'ans4-4', html: `2<span class="frac"><span>1</span><span class="bottom">114</span></span>` },
                { id: 'ans4-5', html: `<b>๒<span class="frac"><span>๑</span><span class="bottom">๑๑๔</span></span></b>` }
            ]
        }
    ];

    const allAnswers = problemsData.flatMap(p => p.answers);

    // --- State Management ---
    const gameState = {
        currentPage: 0,
        lives: 3,
        timePerQuestion: 300, // 1 minutes
        timeRemaining: 300,
        timerInterval: null,
        currentTargetSpan: null,
        names: JSON.parse(localStorage.getItem('studentNames')) || ['อันดำ', 'มิกซ์', 'แอม', 'ทราย+ผู้ช่วย', 'พลอย', 'อุ้งอิ้ง', 'แก้ม', 'แบม'],
        mistakesThisPage: new Set() // **NEW: To track mistakes on the current page**
    };

    // --- DOM Elements ---
    const pageContainer = document.getElementById('page-container');
    const optionsContainer = document.getElementById('options-container');
    const nextButton = document.getElementById('next-button');
    const resetButton = document.getElementById('reset-button');
    const livesContainer = document.getElementById('lives-container');
    const timerBar = document.getElementById('timer-bar');
    
    // Spinner Elements
    const spinnerModal = document.getElementById('spinner-modal');
    const wheelCanvas = document.getElementById('wheel-canvas');
    const spinButton = document.getElementById('spin-button');
    const editNamesButton = document.getElementById('edit-names-button');
    const nameEditor = document.getElementById('name-editor');
    const nameTextarea = document.getElementById('name-textarea');
    const saveNamesButton = document.getElementById('save-names-button');
    const ctx = wheelCanvas.getContext('2d');

    // --- Wheel Logic ---
    const wheel = {
        colors: ['#ff8f8f', '#ffda8f', '#bfff8f', '#8ffffa', '#8f9eff', '#d18fff'],
        angle: 0, spinSpeed: 0, isSpinning: false,

        draw() {
            const numOptions = gameState.names.length;
            const arcSize = (2 * Math.PI) / numOptions;
            ctx.clearRect(0, 0, 400, 400);
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 3;
            ctx.font = '16px Sarabun';

            for (let i = 0; i < numOptions; i++) {
                const angle = this.angle + i * arcSize;
                ctx.fillStyle = this.colors[i % this.colors.length];
                ctx.beginPath();
                ctx.arc(200, 200, 190, angle, angle + arcSize, false);
                ctx.arc(200, 200, 0, angle + arcSize, angle, true);
                ctx.stroke();
                ctx.fill();

                ctx.save();
                ctx.fillStyle = '#000';
                ctx.translate(200 + Math.cos(angle + arcSize / 2) * 100, 200 + Math.sin(angle + arcSize / 2) * 100);
                ctx.rotate(angle + arcSize / 2 + Math.PI / 2);
                ctx.fillText(gameState.names[i], -ctx.measureText(gameState.names[i]).width / 2, 0);
                ctx.restore();
            }
             // Draw pointer
            ctx.fillStyle = 'black';
            ctx.beginPath();
            ctx.moveTo(380, 190); ctx.lineTo(380, 210); ctx.lineTo(350, 200);
            ctx.closePath(); ctx.fill();
        },
        spin() {
            if (this.isSpinning) return;
            this.isSpinning = true;
            this.spinSpeed = Math.random() * 0.2 + 0.2; // Initial speed
            this.update();
        },
        update() {
            this.angle += this.spinSpeed;
            this.spinSpeed *= 0.99; // Slow down
            this.draw();
            if (this.isSpinning) {
                if (this.spinSpeed < 0.001) this.stop();
                else requestAnimationFrame(() => this.update());
            }
        },
        stop() {
            this.isSpinning = false;
            const numOptions = gameState.names.length;
            const degrees = this.angle * 180 / Math.PI;
            const arcSize = 360 / numOptions;
            const index = Math.floor(((360 - degrees % 360) % 360) / arcSize);
            const winner = gameState.names[index];
            if(gameState.currentTargetSpan) gameState.currentTargetSpan.textContent = winner;
            setTimeout(() => { spinnerModal.style.display = 'none'; }, 500);
        }
    };
    
    // --- Game Logic ---
    function initGame() {
        createPages();
        setupOptions();
        goToPage(0);
        updateLivesDisplay();
    }

    function createPages() {
        pageContainer.innerHTML = '';
        problemsData.forEach((prob, index) => {
            const page = document.createElement('div');
            page.className = 'page';
            page.id = `page-${index}`;
            let linesHtml = `<h3>${prob.question}</h3>`;
            for(let i=0; i < prob.lines; i++) {
                const answerId = prob.answers[i].id;
                const isFinalAnswer = i === prob.lines - 1;
                // **UPDATED: Add unique ID to each drop zone**
                linesHtml += `
                    <div class="problem-line">
                        ${isFinalAnswer ? '<b>ตอบ</b>' : '<span class="equals">=</span>'}
                        <div class="drop-zone" id="dz-p${index}-l${i}" data-answer="${answerId}"></div>
                        <button class="student-assign-btn" data-target="name-${index}-${i}">สุ่มชื่อ</button>
                        <span class="student-name" id="name-${index}-${i}"></span>
                    </div>`;
            }
            page.innerHTML = linesHtml;
            pageContainer.appendChild(page);
        });
        addDragDropListeners();
        addStudentButtonListeners();
    }
    
    function setupOptions() {
        optionsContainer.innerHTML = '';
        const shuffledAnswers = allAnswers.slice().sort(() => Math.random() - 0.5);
        shuffledAnswers.forEach(option => {
            if (!option || typeof option.html === 'undefined') return;
            const el = document.createElement('div');
            el.classList.add('draggable');
            el.setAttribute('draggable', true);
            el.id = option.id;
            el.innerHTML = option.html;
            optionsContainer.appendChild(el);
        });
        addDragDropListeners();
    }

    function goToPage(pageIndex) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        const newPage = document.getElementById(`page-${pageIndex}`);
        if(newPage) {
            newPage.classList.add('active');
            gameState.currentPage = pageIndex;
            gameState.mistakesThisPage.clear(); // **UPDATED: Reset mistake tracker for new page**
            resetTimer();
            startTimer();
            if (pageIndex === problemsData.length - 1) nextButton.textContent = 'เสร็จสิ้น';
            else nextButton.textContent = 'ข้อถัดไป';
        } else {
            stopTimer();
            alert(`เกมจบแล้ว! คุณเหลือ ${gameState.lives} ❤️`);
        }
    }

    function nextProblem() {
        if (gameState.currentPage < problemsData.length - 1) {
            goToPage(gameState.currentPage + 1);
        } else {
            stopTimer();
            alert(`ยินดีด้วย! คุณทำครบทุกข้อแล้ว เหลือ ${gameState.lives} ❤️`);
        }
    }
    
    function resetGame() {
        if (!confirm('คุณต้องการเริ่มต้นเกมใหม่ทั้งหมดหรือไม่?')) return;
        gameState.lives = 3;
        gameState.mistakesThisPage.clear(); // **UPDATED: Reset mistake tracker**
        updateLivesDisplay();
        document.querySelectorAll('.drop-zone').forEach(zone => {
            zone.innerHTML = '';
            zone.classList.remove('correct', 'incorrect');
        });
        document.querySelectorAll('.student-name').forEach(span => span.textContent = '');
        setupOptions();
        goToPage(0);
    }
    
    // --- Timer and Lives ---
    function loseLife() {
        if(gameState.lives <= 0) return;
        gameState.lives--;
        updateLivesDisplay();
    }

    function updateLivesDisplay() {
        livesContainer.innerHTML = '';
        for(let i=0; i<gameState.lives; i++) { livesContainer.innerHTML += '❤️'; }
        if (gameState.lives <= 0) {
            stopTimer();
            alert('เกมจบแล้ว! หัวใจหมด');
        }
    }

    function startTimer() {
        stopTimer();
        gameState.timeRemaining = gameState.timePerQuestion;
        gameState.timerInterval = setInterval(() => {
            gameState.timeRemaining--;
            const percentage = (gameState.timeRemaining / gameState.timePerQuestion) * 100;
            timerBar.style.width = `${percentage}%`;
            if (percentage < 50) timerBar.style.backgroundColor = '#faad14';
            if (percentage < 20) timerBar.style.backgroundColor = 'var(--danger-color)';
            if(gameState.timeRemaining <= 0) {
                stopTimer();
                alert('หมดเวลาสำหรับข้อนี้! เสียหัวใจ 1 ดวง');
                loseLife();
                if (gameState.lives > 0) nextProblem();
            }
        }, 1000);
    }
    
    function stopTimer() { clearInterval(gameState.timerInterval); }
    function resetTimer() {
        stopTimer();
        gameState.timeRemaining = gameState.timePerQuestion;
        timerBar.style.width = '100%';
        timerBar.style.backgroundColor = 'var(--success-color)';
    }

    // --- Event Listeners ---
    function addDragDropListeners() {
        document.querySelectorAll('.draggable').forEach(draggable => {
            draggable.addEventListener('dragstart', (e) => e.target.classList.add('dragging'));
            draggable.addEventListener('dragend', (e) => e.target.classList.remove('dragging'));
        });

        document.querySelectorAll('.drop-zone').forEach(zone => {
            zone.addEventListener('dragover', e => {
                e.preventDefault();
                if (zone.children.length === 0) zone.classList.add('over');
            });
            zone.addEventListener('dragleave', e => zone.classList.remove('over'));
            zone.addEventListener('drop', e => {
                e.preventDefault();
                zone.classList.remove('over');
                if (zone.children.length > 0) return;
                const draggedElement = document.querySelector('.dragging');
                if (!draggedElement) return;
                
                if (zone.dataset.answer === draggedElement.id) {
                    // CORRECT ANSWER
                    draggedElement.classList.remove('dragging');
                    zone.appendChild(draggedElement);
                    zone.classList.add('correct');
                } else {
                    // **UPDATED WRONG ANSWER LOGIC**
                    // Only lose a life if this is the FIRST mistake on this specific line.
                    if (!gameState.mistakesThisPage.has(zone.id)) {
                        loseLife();
                        gameState.mistakesThisPage.add(zone.id); // Mark this line as having had a mistake.
                    }
                    
                    // Visual feedback always happens on wrong drop
                    zone.classList.add('incorrect');
                    setTimeout(() => zone.classList.remove('incorrect'), 500);
                }
            });
        });
    }

    function addStudentButtonListeners() {
        document.querySelectorAll('.student-assign-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                gameState.currentTargetSpan = document.getElementById(btn.dataset.target);
                spinnerModal.style.display = 'flex';
                wheel.draw();
            });
        });
    }

    spinButton.addEventListener('click', () => wheel.spin());
    spinnerModal.addEventListener('click', (e) => {
        if (e.target === spinnerModal) spinnerModal.style.display = 'none';
    });
    editNamesButton.addEventListener('click', () => {
        nameEditor.style.display = nameEditor.style.display === 'block' ? 'none' : 'block';
        nameTextarea.value = gameState.names.join(', ');
    });
    saveNamesButton.addEventListener('click', () => {
        const newNames = nameTextarea.value.split(/[\n,]/).map(name => name.trim()).filter(name => name);
        if (newNames.length > 0) {
            gameState.names = newNames;
            localStorage.setItem('studentNames', JSON.stringify(newNames));
            wheel.draw();
            nameEditor.style.display = 'none';
        } else {
            alert('กรุณาใส่รายชื่ออย่างน้อยหนึ่งชื่อ');
        }
    });

    nextButton.addEventListener('click', nextProblem);
    resetButton.addEventListener('click', resetGame);
    
    // --- Initial Call ---
    document.addEventListener('DOMContentLoaded', initGame);
    </script>
</body>

</html>
